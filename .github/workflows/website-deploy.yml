name: Simple Web Application Deployment

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy to Apache Web Server on Azure
    runs-on: ubuntu-latest
    env:
      SERVER_PRIVATE_KEY: ${{ secrets.SSH_KEY }}
      SERVER_HOST: ${{ secrets.AZURE_VM_IP }}
      SERVER_USER: ${{ secrets.AZURE_VM_USENAME}}
    steps:
      - name: Checkout the Code
        uses: actions/checkout@v2.4.2

      # - name: Zip the Files
      #   run: |
      #     echo "Zip the Files"
      #     tar -cvzf website.tar.gz src


      # - name: Method 1 - for index.html
      #   run: |
      #     echo "$SERVER_PRIVATE_KEY" > key.pem
      #     chmod 600 key.pem
      #     scp -i key.pem -o StrictHostKeyChecking=no website.tar.gz $SERVER_USER@$SERVER_HOST:/tmp/
      #     scp -i key.pem -o StrictHostKeyChecking=no movefiles.sh $SERVER_USER@$SERVER_HOST:/tmp/
      #     ssh -i key.pem -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST 'chmod +x /tmp/movefiles.sh'
      #     ssh -i key.pem -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST '/tmp/movefiles.sh'
      #   continue-on-error: true

      - name: Copy the Public Folder to Ubuntu
        uses: marcodallasanta/ssh-scp-deploy@v1.2.0
        with:
          local: 'src/*'
          remote: '/var/www/html/'
          host: ${{secrets.AZURE_VM_IP}}
          user: ${{secrets.AZURE_VM_USENAME}}
          key: ${{secrets.SSH_KEY}}
          ssh_options: -o StrictHostKeyChecking=no
          #pre_upload: sudo rm -rf /var/www/html/*
          #post_upload: ls -la ~/public
          #post_upload: sudo mv ~/public/* /var/www/html/

      # - name: Method 1 - for index.html
      #   run: |
      #     echo "$SERVER_PRIVATE_KEY" > key.pem
      #     chmod 600 key.pem
      #     scp -i key.pem -o StrictHostKeyChecking=no index.html $SERVER_USER@$SERVER_HOST:/tmp/
      #     ssh -i key.pem -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "sudo mv /tmp/index.html /var/www/html/index.html"
      #   continue-on-error: true



      # - name: Method 2 - for about.html
      #   run: |
      #     touch devapacheserver.pem
      #     echo "${{ secrets.SSH_KEY }}" >> devapacheserver.pem
      #     chmod 600 devapacheserver.pem
      #     scp -i devapacheserver.pem -o StrictHostKeyChecking=no about.html $SERVER_USER@$SERVER_HOST:/tmp/
      #   continue-on-error: true
